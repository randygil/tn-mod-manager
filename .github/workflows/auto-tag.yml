name: ğŸ·ï¸ Auto Tag

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to tag (e.g., v1.0.0)"
        required: true
        type: string
      create_release:
        description: "Create release immediately"
        required: false
        type: boolean
        default: true

jobs:
  create-tag:
    name: ğŸ·ï¸ Create Tag
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history needed for tagging

      - name: ğŸ¦• Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - name: âœ… Validate version format
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [[ ! $VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-.*)?$ ]]; then
            echo "âŒ Invalid version format: $VERSION"
            echo "Expected format: v1.0.0 or v1.0.0-beta"
            exit 1
          fi
          echo "âœ… Version format is valid: $VERSION"

      - name: ğŸ” Check if tag exists
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "âŒ Tag $VERSION already exists!"
            exit 1
          fi
          echo "âœ… Tag $VERSION is available"

      - name: ğŸ§ª Run validation
        run: |
          echo "ğŸ” Running pre-tag validation..."
          deno lint
          deno check main.ts
          echo "âœ… Validation passed"

      - name: ğŸ”¨ Test build
        run: |
          echo "ğŸ”¨ Testing compilation..."
          deno compile --allow-all --target x86_64-pc-windows-msvc --output test-build.exe main.ts
          if [ ! -f "test-build.exe" ]; then
            echo "âŒ Build test failed"
            exit 1
          fi
          rm test-build.exe
          echo "âœ… Build test passed"

      - name: ğŸ·ï¸ Create and push tag
        run: |
          VERSION="${{ github.event.inputs.version }}"

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Create annotated tag with release info
          git tag -a "$VERSION" -m "Release $VERSION

          Auto-tagged by GitHub Actions
          Commit: ${{ github.sha }}
          Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')

          ğŸ® Minecraft Mod Manager $VERSION

          Built with â˜• and TypeScript"

          # Push the tag
          git push origin "$VERSION"

          echo "âœ… Tag $VERSION created and pushed"

      - name: ğŸ‰ Trigger release workflow
        if: ${{ github.event.inputs.create_release == 'true' }}
        run: |
          echo "ğŸš€ Release workflow will be triggered automatically by the tag push"
          echo "ğŸ”— Monitor the release at: ${{ github.server_url }}/${{ github.repository }}/actions"

      - name: ğŸ“‹ Summary
        run: |
          VERSION="${{ github.event.inputs.version }}"
          echo "ğŸ¯ Summary:"
          echo "â”œâ”€â”€ âœ… Tag created: $VERSION"
          echo "â”œâ”€â”€ ğŸ”— Tag URL: ${{ github.server_url }}/${{ github.repository }}/releases/tag/$VERSION"
          if [[ "${{ github.event.inputs.create_release }}" == "true" ]]; then
            echo "â”œâ”€â”€ ğŸš€ Release workflow triggered"
            echo "â””â”€â”€ ğŸ“¦ Binaries will be available shortly"
          else
            echo "â””â”€â”€ â¸ï¸  Release workflow NOT triggered (manual trigger required)"
          fi
